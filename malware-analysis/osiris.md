# Osiris

### Introduction

Osiris (not to be confused with the ransomware with the same name), is a banking trojan released in July 2018 which is a descendant of the Kronos banking trojan. Like its predecessors, it will steal credentials from victim computers

### Analysis

The executable is a 32 bit executable compiled with Microsoft Visual C++:

![](<../.gitbook/assets/image (3).png>)

When started, the malware will spawn wermgr.exe as a suspended process:

![](https://lh3.googleusercontent.com/ASye577l6dSpzlBzm-TiLiSfp07jJetbooHm7iH8wG9DMEKbu6URhSIFsRnrmxJyGuaNKUnrr6DzVW5D\_VSflEjNNaZ6bf7w3shdSjvqZTYmbquVnWgQAhhLTD5S-\_gxhqmdgbI8CEPwQaudiw)

After spawning wermgr.exe, Osiris will perform transacted hollowing, which is a hybrid of process hollowing and process doppelganging to overwrite wermgr.exe to run a malicious payload found within the malware.

#### Using transacted hollowing

The process calls the following APIs to create a transacted file at "%TEMP%\Liebert.tmp" and write a malicious payload to the file before rolling back the transaction:

* ZwCreateTransaction

![](https://lh3.googleusercontent.com/dINplm-GlXCA50OZ1Uny-\_S0GkxjrAimwYI1rmaTd-2WGxBDhhQo\_UP9boaO6QImd-7JXeiZ4YhEFn8zpUvcev43D4MmRDTOLusF6Fsn5JzyZg09utX47RI4MttWRYuYAqIpivDBizS4uZPFFQ)

* RtlSetCurrentTransaction

![](https://lh6.googleusercontent.com/kMvYWOF5hwvB2BUAbsiH-y2QT\_ICB5LkE4RzqrD22yUOCvV21pPn-6QhjIBNThZRyS8tudrNURBobIuYjDONPlJikVX-zyX7zk56gNAHR3mFp\_vn572tU4w1MiBcDzbeJAe\_vGR6gt3Sgia9Wg)

* ZwCreateFile

![](https://lh4.googleusercontent.com/khyQHiP\_\_raK22xeaHtWbK0hPZwB7bUxOe08PxprhNq4mjoWDiqazkRvfO3\_GOF21xPGNYKWXuTFS6zdXDhyuJC-h3QtXIEzzq6r62U1gfik1OJ2nYDxutSeOAON\_dxuEX9gnL2RpoYHzed9Pg)

![](https://lh3.googleusercontent.com/jVDyFvrTrwUkSlVdkEQ81cDQYEfaKKLj5zZvDhmGRg69aLW-OGNeQ-iSfvbx5\_RxpJWA9JjLyMpwmWFH81qb\_8mymt5WzrTqnBIGD9cn7vFm9geG8k44LUY29ySwGzesQehnhrMOKk9cBQd2jg)

* ZwWritefile

![](https://lh5.googleusercontent.com/B92HoZQrFj00vL4nxWdOtjKHwFYeggKFoiOShvYWMlP4-e4l7WVU8bvlswMtlbuUMx8ITibGSAeHSti7yBU6vwuweHJgPp0nrhQwPmrUqZ\_rEa5H7NXM8VAlzH0dsBOMWLqpfdUWy-e7NzMNWA)

* ZwCreateSection
  * Allows malicious payload to remain in memory

![](https://lh3.googleusercontent.com/nKV\_QW9\_l9rtenbmUDS5Kep35Owkg7nEcEIsOUef77FmKKfR0MOMtQsWYIw8Yu6luC98F2eli1Kj4Gas6UFO8SCeOibciwoYljedjJf1m2JVg9Ad-Xn\_aJ\_mMrCdiqvrgSDHaJQ48c\_LkCJI2g)

* NtRollbackTransaction
  * Prevent the file from actually being created

![](https://lh4.googleusercontent.com/GYNbnDF5EnDefNLQaXCrVN85y7J\_y\_l-ACfDawbcR\_FfYpAyZHOKqg-OYS3iXrTgRIOb6sSUCQfEptnPcZ0QrM7lTWFSGK-3mcoalMEG0QwhnlGqyysB9cUu0YWW\_FMkgPH8nh4IJ9sNVRQNDw)

Using these API calls, the malware can load its malicious payload into memory without writing to disk, evading AV file scans

When analysing the call to ZwWriteFile, I was able to find the payload that will be loaded:

![Definitely an exe :D](https://lh6.googleusercontent.com/AyeMEWQPMkFEiGXLt97z6Ct0xX-4B1L2QEuay-j46F7FPeyY4aBtqx261u6JMUAHsjvGiV08L6rbu4WgSSvJYWqmeulH9Cv9SJTPQ9mhUcyX2s1PT\_eZgadh9dj5ywKZrfWpUaIqfynaKf6lkw)

From there, the malware will call the following calls to inject the exe into wermgr.exe and run it:

* NtMapViewofSection
  * Loads payload into wermgr.exe

![](https://lh5.googleusercontent.com/odZ8QCQwUkLIdOmix41-Vuf67nGh08lhGRsDDy1TJq3IHeJy\_eTnUQQJOzKmW7jziJmjsXuIBTcz1EUU2CnPS4lC4ddbUSOHVjqIjhlcpnifThvywbvu8D3XvUo4kOp7DC8oh8mY\_-p-ukjXug)

* ZwProtectVirtualMemory

![Set to rw then write](https://lh5.googleusercontent.com/C5fS3ZBqOdLbdVy-7hkUESM2yMVRz3fHI5xw8C\_gsBi6KGEYvqZq3RUyrTKg9W3TUy0y28oAb6yQhbdMhucQlTyNEfYX6NME2wqr-3M4LkGqWma0PEgEs9zJWk7xagxtQ0A5B5fogNZcsYOaRQ)

![Set to rx](https://lh4.googleusercontent.com/FvlSzD5Me-NbjwCruY3yLHYSvy1rfRZZPaU0g17RjEav5AYId3iZNiMOr8CSjPNIskie5wcyUWMTFMtkyccH7TuZeTHTQEnvQaqen3\_h0lebnY3zCJHEBTYYpZIy2WvlXx-6FfrhYRr-Ko1LTg)

* NtWriteVirtualMemory
* ZwResumeThread
  * Runs the payload

![](https://lh3.googleusercontent.com/nC0UdXu4FONIcEHIMED5Hx3-6Uq3wOegpK7Tybm-M-uqhs-ynGzMFs9-griSh\_rFs2F2IUI0o5pHu-FPFNHoBQEUhpInNS1UUhWn0y22HSd8JVmeBV0SZcC4vwI39J\_ThGU49Veop2cJtADYXg)

Interestingly, this malware decided not to run UnmapViewOfSection like most malware do when hollowing a process. Instead, it opted to overwrite the first instruction of the entry function to wermgr.exe to jump to the malicious payload instead. After writing, it will resume thread and run the payload.

#### Malicious Payload

The malicious payload is another 32 bit executable:

![](<../.gitbook/assets/image (26).png>)

Based on entropy analysis, it is safe to say that the malware is definitely packed to oblivion:

![bruh](<../.gitbook/assets/image (27).png>)

The unpacking sequence is a convoluted mess which I would not go in. But the jeez is, the malware undergoes a lot of xoring and DLLs were loaded dynamically via LoadLibraryA and APIs loaded via API hash resolving/GetProcAddress. After that, I decided to take a memory snapshot using IDA of the final payload and got the full unpacked malware! ;D

When the final payload is run, the program calls 2 threads, one for keylogging and another one for the normal C2 table:

![](<../.gitbook/assets/image (2).png>)

### Key Activities

#### C2 via tor

When searching strings found in the malware, the following URL is found:

![](<../.gitbook/assets/image (23).png>)

The url `http://suzfjfguuis326qw`\[`.]onion/kpanel/connect.php`seems to be an onion link, which means that the C2 works using tor, making communication between the process and C2 server more secure and harder to track down the actual C2 server

#### Steal credentials from browsers

The malware is also capable of reading passwords stored in Google Chrome and Firefox, where they used sqlite to retrieve login information stored in Chrome by using SQL:

![Getting path for Chrome passwords](<../.gitbook/assets/image (16).png>)

![Retrieving data by copying the data to the current directory and reading from it via a SQL query](<../.gitbook/assets/image (17).png>)

![Getting value from the columns for url,username and password](<../.gitbook/assets/image (11).png>)

For firefox, it will get the install directory and read login.json in that directory, extracting the saved passwords from there:

![](<../.gitbook/assets/image (22).png>)

![reading the json file and extracting the encrypted passwords and username](<../.gitbook/assets/image (15).png>)

From there it will decrypt the usernames and passwords using a default key since earlier versions of firefox use a default key to encrypt all the information stored in saved logins.

The passwords will then be saved in a file called "log" in the same directory as the malware.

![Creating the log file before extracting passwords](<../.gitbook/assets/image (18).png>)

![Writing to log file](<../.gitbook/assets/image (24).png>)

#### Dropping Exes and running them&#x20;

The malware is able to download an exe from the C2 and execute it. This can be used for further exploitation of the victim by dropping ransomwares/other malware to increase damage dealt to the victim's computer&#x20;

![](<../.gitbook/assets/image (21).png>)

![](<../.gitbook/assets/image (25).png>)

#### VNC

When analyzing, I manage to find the following Strings:

![](<../.gitbook/assets/image (12).png>)

This implies that the malware uses vnc to provide a remote desktop to the remote actor which will allow them to remotely control the computer and get more information about the user.

Upon some digging, it can be deduced that the malware connects to the remote server at a certain port designated by the C2 server before connecting.

#### Keylogging

The malware also includes a keylogger that will track keyboard activity at windows which will help to capture sensitive information such as usernames and passwords for them to hijack their accounts.

![setting the hook](<../.gitbook/assets/image (10).png>)

![capturing keystrokes together with current window title](<../.gitbook/assets/image (20).png>)

### Indicators of Compromise:

```
MD5: 5E6764534B3A1E4D3ABACC4810B6985D
SHA1: F10AD287F126F577F197070453812A7E88C2CC52
SHA256: e7d3181ef643d77bb33fe328d1ea58f512b4f27c8e6ed71935a2e7548f2facc0
```

* Files dropped:
  * %MALWAREDIR%\log
  * %MALWAREDIR%\\%d.exe
* Mutexes
  * Global{AD3EBBCA-D942-886C-AD3E-CABB824AEA00}
* Network
  * http://suzfjfguuis326qw\[.]onion/kpanel/connect.php
